import numpy as np
import sys
from os import listdir
from os.path import isfile, join

FEATURES = {
    "feature": 1,
    "permission": 2,
    "activity": 3,
    "service_receiver": 3,
    "provider": 3,
    "service": 3,
    "intent": 4,
    "api_call": 5,
    "real_permission": 6,
    "call": 7,
    "url": 8
}


def count(lines):
    features_dict = {x: 0 for x in range(1, 9)}
    for i in lines:
        if i != "\n":  # If not the end of line
            set = i.split("::")[0]  # Keep the set name
            features_dict[FEATURES[set]] += 1  # Update the value at each occurrence
    features = []
    for i in range(1, 9):
        features.append(features_dict[i])

    return features


# Test for feature vectors' values
#
# sys.stdin = open("deneme4")
# feat = sys.stdin.readlines()
# print(count_feature_set(feat))
#

# Test for vectors' count
# c = 0
# for f in listdir("feature_vectors"):  # 19.022 files
#     if isfile(join("feature_vectors", f)):
#         res = f
#         c += 1
# print(c)


real_values = np.loadtxt("sha256_family.csv", delimiter=",", skiprows=1, dtype=str)
family_name = (real_values[:, 1])
sha256 = (real_values[:, 0])
malware = []
not_malware = []

# https://stackoverflow.com/questions/3207219/how-do-i-list-all-files-of-a-directory/40548378
q = [f for f in listdir("feature_vectors") if isfile(join("feature_vectors", f))]
for detected in q:
    if detected in real_values:
        malware.append(detected)
    else:
        if len(not_malware) < 5560:
            not_malware.append(detected)

# print(malware)
# print(not_malware)

X = []
y = []
# Assign 0 for not virus
#        1 for virus for y

for files in malware:
    sys.stdin = open("feature_vectors/%s" % files)
    features = sys.stdin.readlines()
    feat_vec = count(features)
    X.append(feat_vec)
    y.append(1)

for text_file in not_malware:
    sys.stdin = open("feature_vectors/%s" % files)
    features = sys.stdin.readlines()
    sample = count(features)
    X.append(sample)
    y.append(0)

X = np.array(X)
y = np.array(y)

print(X)

X = X.shape
y = y.shape

print(X,y)